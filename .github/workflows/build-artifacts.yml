name: Build and Release DMF

on:
  push:
    branches:
      - master
      - release/**
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_OS_LIST: '20H1,19H1'
  CONFIGURATION_LIST: 'Release,Debug'
  PLATFORM_LIST: 'x64,arm64'
  BUILD_BINARIESDIRECTORY: '${{ github.workspace }}\.output\b'
  BUILD_ARTIFACTSTAGINGDIRECTORY: '${{ github.workspace }}\.output\a'

jobs:
  build:
    name: Build (${{ matrix.target_os }} ${{ matrix.platform }} ${{ matrix.configuration }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        target_os: [20H1, 19H1]
        configuration: [Release, Debug]
        platform: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build DMF
        shell: pwsh
        run: |
          $params = @{
            TargetOS = '${{ matrix.target_os }}'
            Configuration = '${{ matrix.configuration }}'
            Platform = '${{ matrix.platform }}'
          }
          ./build/build.ps1 @params

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Bin_${{ matrix.target_os }}_${{ matrix.platform }}_${{ matrix.configuration }}
          path: ./.output/b/Bin_${{ matrix.target_os }}_${{ matrix.platform }}_${{ matrix.configuration }}
          if-no-files-found: error
          retention-days: 7

  package-and-release:
    name: Pack and Release
    runs-on: windows-2022
    needs: build
    if: ${{ github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v') }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.BUILD_BINARIESDIRECTORY }}
          merge-multiple: true

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine semantic version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1
        with:
          useConfigFile: true
          configFilePath: build/GitVersion.yml

      - name: Pack libraries and headers
        shell: pwsh
        run: |
          $params = @{
            Action = 'Pack'
            TargetOS = '${{ env.TARGET_OS_LIST }}'
            Configuration = '${{ env.CONFIGURATION_LIST }}'
            Platform = '${{ env.PLATFORM_LIST }}'
          }
          ./build/build.ps1 @params

      - name: Archive library drops
        shell: pwsh
        run: |
          $archivesRoot = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY -ChildPath 'archives'
          if (Test-Path $archivesRoot) {
            Remove-Item $archivesRoot -Recurse -Force
          }
          $null = New-Item $archivesRoot -ItemType Directory -Force

          Get-ChildItem -Path $env:BUILD_BINARIESDIRECTORY -Directory -Filter 'Bin_*' | ForEach-Object {
            $zipPath = Join-Path $archivesRoot -ChildPath ("{0}.zip" -f $_.Name)
            if (Test-Path $zipPath) {
              Remove-Item $zipPath -Force
            }
            Compress-Archive -Path (Join-Path $_.FullName '*') -DestinationPath $zipPath
          }

      - name: Archive public headers
        shell: pwsh
        run: |
          $headerSource = (Join-Path $env:GITHUB_WORKSPACE 'DMF').TrimEnd('\')
          $headerTemp = Join-Path $env:RUNNER_TEMP 'dmf-headers'
          if (Test-Path $headerTemp) {
            Remove-Item $headerTemp -Recurse -Force
          }
          $null = New-Item $headerTemp -ItemType Directory -Force

          Get-ChildItem -Path $headerSource -Recurse -File -Filter '*.h' | ForEach-Object {
            $relative = $_.FullName.Substring($headerSource.Length).TrimStart('\', '/')
            $destination = Join-Path $headerTemp $relative
            $destDir = Split-Path $destination -Parent
            if (-not (Test-Path $destDir)) {
              $null = New-Item $destDir -ItemType Directory -Force
            }
            Copy-Item -Path $_.FullName -Destination $destination -Force
          }

          $headerArchive = Join-Path (Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY 'archives') 'DMF-Headers.zip'
          if (Test-Path $headerArchive) {
            Remove-Item $headerArchive -Force
          }
          Compress-Archive -Path (Join-Path $headerTemp '*') -DestinationPath $headerArchive

      - name: Create or update tag
        shell: pwsh
        run: |
          git config user.email "github-actions@users.noreply.github.com"
          git config user.name "github-actions"

          $tag = "v${{ steps.gitversion.outputs.SemVer }}"
          git rev-parse -q --verify $tag 2>$null
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Tag $tag already exists. Skipping push."
            exit 0
          }

          git tag $tag
          git push origin $tag

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.gitversion.outputs.SemVer }}
          name: DMF v${{ steps.gitversion.outputs.SemVer }}
          artifacts: ".output/a/archives/*.zip,.output/a/*.nupkg"
          artifactErrorsFailBuild: true
          generateReleaseNotes: true
          allowUpdates: true
