name: Build and Release DMF

on:
  push:
    branches:
      - master
      - release
      - release/**
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

env:
  TARGET_OS_LIST: '20H1'
  CONFIGURATION_LIST: 'Release,Debug'
  PLATFORM_LIST: 'x64,arm64'
  BUILD_BINARIESDIRECTORY: '${{ github.workspace }}\.output\b'
  BUILD_ARTIFACTSTAGINGDIRECTORY: '${{ github.workspace }}\.output\a'

jobs:
  build:
    name: Build (${{ matrix.target_os }} ${{ matrix.platform }} ${{ matrix.configuration }})
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        target_os: [20H1]
        configuration: [Release, Debug]
        platform: [x64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build DMF
        shell: pwsh
        run: |
          $params = @{
            TargetOS = '${{ matrix.target_os }}'
            Configuration = '${{ matrix.configuration }}'
            Platform = '${{ matrix.platform }}'
          }
          ./build/build.ps1 @params

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Bin_${{ matrix.target_os }}_${{ matrix.platform }}_${{ matrix.configuration }}
          path: ./.output/b/Bin_${{ matrix.target_os }}_${{ matrix.platform }}_${{ matrix.configuration }}
          if-no-files-found: error
          retention-days: 7

  package-and-release:
    name: Pack and Release
    runs-on: windows-2022
    needs: build
    if: ${{ github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: ${{ env.BUILD_BINARIESDIRECTORY }}
          merge-multiple: true

      - name: Install GitVersion
        uses: gittools/actions/gitversion/setup@v1
        with:
          versionSpec: '5.x'

      - name: Determine semantic version
        id: gitversion
        uses: gittools/actions/gitversion/execute@v1
        with:
          useConfigFile: true
          configFilePath: build/GitVersion.yml

      - name: Pack libraries and headers
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # Create a redistributable include folder containing only public headers.
          # Content:
          # - Dmf/Framework/**.h
          # - Dmf/Modules.Library/**.h
          # - Dmf/Modules.Template/**.h
          $includeRoot = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY -ChildPath 'include'
          if (Test-Path $includeRoot) {
            Remove-Item $includeRoot -Recurse -Force
          }
          $null = New-Item $includeRoot -ItemType Directory -Force

          $headerMaps = @(
            @{
              SourceRoot = Join-Path $env:GITHUB_WORKSPACE 'Dmf\Framework'
              DestRoot   = Join-Path $includeRoot 'Dmf\Framework'
            },
            @{
              SourceRoot = Join-Path $env:GITHUB_WORKSPACE 'Dmf\Modules.Library'
              DestRoot   = Join-Path $includeRoot 'Dmf\Modules.Library'
            },
            @{
              SourceRoot = Join-Path $env:GITHUB_WORKSPACE 'Dmf\Modules.Template'
              DestRoot   = Join-Path $includeRoot 'Dmf\Modules.Template'
            }
          )

          foreach ($map in $headerMaps) {
            if (-not (Test-Path $map.SourceRoot)) {
              throw "Header source directory not found: $($map.SourceRoot)"
            }
            Get-ChildItem -Path $map.SourceRoot -Recurse -File -Filter '*.h' | ForEach-Object {
              $relative = $_.FullName.Substring($map.SourceRoot.Length).TrimStart('\', '/')
              $destination = Join-Path $map.DestRoot $relative
              $destDir = Split-Path $destination -Parent
              if (-not (Test-Path $destDir)) {
                $null = New-Item $destDir -ItemType Directory -Force
              }
              Copy-Item -Path $_.FullName -Destination $destination -Force
            }
          }

      - name: Archive library drops
        shell: pwsh
        run: |
          $archivesRoot = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY -ChildPath 'archives'
          if (Test-Path $archivesRoot) {
            Remove-Item $archivesRoot -Recurse -Force
          }
          $null = New-Item $archivesRoot -ItemType Directory -Force

          $targetOsList = $env:TARGET_OS_LIST.Split(',').Trim()
          $configurationList = $env:CONFIGURATION_LIST.Split(',').Trim()
          $platformList = $env:PLATFORM_LIST.Split(',').Trim()

          foreach ($tos in $targetOsList) {
            foreach ($platform in $platformList) {
              foreach ($config in $configurationList) {
                $expectedPath = Join-Path $env:BUILD_BINARIESDIRECTORY -ChildPath ("Bin_{0}_{1}_{2}" -f $tos, $platform, $config)
                if (-not (Test-Path $expectedPath)) {
                  throw "Missing build artifact: $expectedPath"
                }
              }
            }
          }

          $tempRoot = Join-Path $env:RUNNER_TEMP 'dmf-libs'
          if (Test-Path $tempRoot) {
            Remove-Item $tempRoot -Recurse -Force
          }
          $null = New-Item $tempRoot -ItemType Directory -Force

          Get-ChildItem -Path $env:BUILD_BINARIESDIRECTORY -Directory -Filter 'Bin_*' | ForEach-Object {
            $platform = 'unknown'
            if ($_.Name -match '^Bin_[^_]+_(?<platform>[^_]+)_[^_]+$') {
              $platform = $matches['platform']
            }

            $platformRoot = Join-Path $archivesRoot -ChildPath $platform
            if (-not (Test-Path $platformRoot)) {
              $null = New-Item $platformRoot -ItemType Directory -Force
            }

            # Copy only *.lib files (not the full drop) preserving folder structure under lib/.
            $libSource = Join-Path $_.FullName 'lib'
            if (-not (Test-Path $libSource)) {
              throw "Missing lib folder in build artifact: $libSource"
            }

            $stagingRoot = Join-Path $tempRoot $_.Name
            if (Test-Path $stagingRoot) {
              Remove-Item $stagingRoot -Recurse -Force
            }
            $null = New-Item (Join-Path $stagingRoot 'lib') -ItemType Directory -Force

            $libFiles = Get-ChildItem -Path $libSource -Recurse -File -Filter '*.lib'
            if ($null -eq $libFiles -or $libFiles.Count -eq 0) {
              throw "No .lib files found under: $libSource"
            }

            $libFiles | ForEach-Object {
              $relative = $_.FullName.Substring($libSource.Length).TrimStart('\', '/')
              $destination = Join-Path (Join-Path $stagingRoot 'lib') $relative
              $destDir = Split-Path $destination -Parent
              if (-not (Test-Path $destDir)) {
                $null = New-Item $destDir -ItemType Directory -Force
              }
              Copy-Item -Path $_.FullName -Destination $destination -Force
            }

            $zipPath = Join-Path $platformRoot -ChildPath ("{0}_libs.zip" -f $_.Name)
            if (Test-Path $zipPath) {
              Remove-Item $zipPath -Force
            }
            Compress-Archive -Path (Join-Path $stagingRoot '*') -DestinationPath $zipPath -Force
          }

      - name: Archive public headers
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $archivesRoot = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY -ChildPath 'archives'
          if (-not (Test-Path $archivesRoot)) {
            $null = New-Item $archivesRoot -ItemType Directory -Force
          }

          # Zip the staged redistributable include folder (rooted at include/).
          $includeRoot = Join-Path $env:BUILD_ARTIFACTSTAGINGDIRECTORY -ChildPath 'include'
          if (-not (Test-Path $includeRoot)) {
            throw "Missing staged include folder: $includeRoot"
          }

          $tempRoot = Join-Path $env:RUNNER_TEMP 'dmf-include-zip'
          if (Test-Path $tempRoot) {
            Remove-Item $tempRoot -Recurse -Force
          }
          $tempInclude = Join-Path $tempRoot 'include'
          $null = New-Item $tempInclude -ItemType Directory -Force
          Copy-Item -Path (Join-Path $includeRoot 'Dmf') -Destination (Join-Path $tempInclude 'Dmf') -Recurse -Force

          $headerArchive = Join-Path $archivesRoot 'DMF-Headers.zip'
          if (Test-Path $headerArchive) {
            Remove-Item $headerArchive -Force
          }
          Compress-Archive -Path $tempInclude -DestinationPath $headerArchive -Force

      - name: Create GitHub release
        uses: ncipollo/release-action@v1
        with:
          tag: v${{ steps.gitversion.outputs.SemVer }}
          name: DMF v${{ steps.gitversion.outputs.SemVer }}
          commit: ${{ github.sha }}
          artifacts: ".output/a/archives/**/*.zip"
          artifactErrorsFailBuild: true
          generateReleaseNotes: true
          allowUpdates: true
